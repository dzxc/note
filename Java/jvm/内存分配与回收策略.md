# 内存分配与回收策略

新生代GC （MinorGC）:指发生在新生代的垃圾收集动作，MinorGC非常频繁，一般回收速度也比较快。

老年代GC （Major GC/FullGC〉：指发生在老年代的GC,出现了 Major GC,经常会伴 随至少一次的MinorGC （但非绝对的，在Parallel Scavenge收集器的收集策略里就有直接 进行Major GC的策略选择过程）-Major GC的速度一般会比Minor GC慢10倍以上。


### 1.对象优先在Eden分配
大多数情况下，对象在新生代Eden区中分配。当Eden区没有足够空间进行分配时，虚拟机将发起一次Minor GC.

### 2.大对象直接进入老年代
大对象指需要大量连续内存空间的Java对象，最典型的大对象就是那种很长的字符串以及数组。大对象对虚拟机的 内存分配来说就是一个坏消息，经常出现大对象容易导致内存还有不少空间时就提前触发垃圾收集以获取足够的连续空间来“安置”它们。

虚拟机提供了"-XX:PretenureSizeThreshold参数，令大于这个设置值的对象直接在老年代分配。这样做的目的是避免在Eden区及两个Survivor区之间发生大量的内存复制


### 3.长期存活的对象将进入老年代
为了做到这点，虚拟机给每个对象定义 了一个对象年龄(Age)计数器。如果对象在Eden出生并经过第一次Minor GC后仍然存活，并且能被Survivor容纳的话，将被移动到Survivor空间中，并且对象年龄设为1。对象在Survivor区中每“熬过”一次Minor GC,年龄就增加1岁，当它的年龄增加到一定程 度(默认为15岁)，就将会被晋升到老年代中。对象晋升老年代的年龄阈值，可以通过参 数-XX:MaxTenuringThreshold 设置。

### 4.动态对象年龄判定
为了能更好地适应不同程序的内存状况，虚拟机并不是永远地要求对象的年龄必须达到 了 MaxTenuringThreshold才能晋升老年代，如果在Survivor空间中相同年龄所有对象大小的 总和大于Survivor空间的一半，年龄大于或等于该年龄的对象就可以直接进人老年代，无须 等到MaxTenuringThreshold中要求的年龄。

### 5.空间分配担保
在发生Minor GC之前，虚拟机会先检查老年代最大可用的连续空间是否大于新生 代所有对象总空间，如果这个条件成立，那么Minor GC可以确保是安全的。如果不成立，则虚拟机会查看HandlePromotionFailure设置值是否允许担保失败。如果允许，那么会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试着进行一次Minor GC,尽管这次Minor GC是有风险的：如果小于或者 HandlePromotionFailure设置不允许冒险，那这时也要改为进行一次Full GC。
